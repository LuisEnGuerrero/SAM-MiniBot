<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>SAM MiniBot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f8fafc;
    }

    #sam-minibot-root {
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      font-size: 14px;
      color: #64748b;
    }
  </style>
</head>

<body>
  <div id="sam-minibot-root">
    <div class="loading">Inicializando SAM MiniBotâ€¦</div>
  </div>

  <script>
    // =====================================================
    // DESIGN TOKENS
    // =====================================================
    const DESIGN_TOKENS = {
      botBg: '#f1f5f9',
      userBg: '#2563eb',
      botText: '#0f172a',
      userText: '#ffffff',
      borderRadius: '14px',
      fontSize: '14px',
      shadow: '0 10px 30px rgba(0,0,0,0.12)'
    };

    let SAM_CONFIG = null;
    let typingIndicator = null;

    // =====================================================
    // RECEIVE CONFIG FROM PARENT (sam-minibot.js)
    // =====================================================
    window.addEventListener('message', (event) => {
      if (!event.data || event.data.type !== 'SAM_MINIBOT_INIT') return;

      SAM_CONFIG = event.data.payload;

      if (!SAM_CONFIG?.clientId || !SAM_CONFIG?.apiBase) {
        showError('ConfiguraciÃ³n invÃ¡lida');
        return;
      }

      initMiniBot(SAM_CONFIG);
    });

    // =====================================================
    // INIT BOT UI
    // =====================================================
    function initMiniBot(config) {
      const root = document.getElementById('sam-minibot-root');
      root.innerHTML = '';

      // Header
      const header = document.createElement('div');
      header.style.display = 'flex';
      header.style.justifyContent = 'space-between';
      header.style.alignItems = 'center';
      header.style.padding = '12px 16px';
      header.style.background = config.theme?.primaryColor || '#2563eb';
      header.style.color = '#fff';
      header.style.fontWeight = '600';

      const title = document.createElement('div');
      title.innerText = config.ui?.title || 'SAM MiniBot';

      const closeBtn = document.createElement('button');
      closeBtn.innerText = 'âœ•';
      closeBtn.style.background = 'transparent';
      closeBtn.style.border = 'none';
      closeBtn.style.color = '#fff';
      closeBtn.style.cursor = 'pointer';
      closeBtn.onclick = () => {
        window.parent.postMessage({ type: 'SAM_MINIBOT_CLOSE' }, '*');
      };

      header.appendChild(title);
      header.appendChild(closeBtn);

      // Messages container
      const messages = document.createElement('div');
      messages.id = 'sam-messages';
      messages.style.flex = '1';
      messages.style.padding = '12px';
      messages.style.overflowY = 'auto';

      // Input
      const form = document.createElement('form');
      form.style.display = 'flex';
      form.style.borderTop = '1px solid #e5e7eb';

      const input = document.createElement('input');
      input.type = 'text';
      input.placeholder = 'Escribe tu mensajeâ€¦';
      input.style.flex = '1';
      input.style.padding = '12px';
      input.style.border = 'none';
      input.style.outline = 'none';

      const button = document.createElement('button');
      button.type = 'submit';
      button.innerText = 'Enviar';
      button.style.padding = '0 16px';
      button.style.border = 'none';
      button.style.cursor = 'pointer';
      button.style.background = config.theme?.primaryColor || '#2563eb';
      button.style.color = '#fff';

      form.appendChild(input);
      form.appendChild(button);

      root.appendChild(header);
      root.appendChild(messages);
      root.appendChild(form);

      // Welcome message
      addMessage(
        'bot',
        config.ui?.welcomeMessage ||
          'Hola ðŸ‘‹ Soy SAM, tu asistente virtual. Â¿En quÃ© puedo ayudarte hoy?'
      );

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const text = input.value.trim();
        if (!text) return;

        input.value = '';

        addMessage('user', text);
        showTyping();

        const result = await sendMessage(config, text);

        hideTyping();
        addMessage('bot', result.response);

        if (result.source === 'default' && result.suggestedFaqs?.length) {
          showFaqSuggestions(config, result.suggestedFaqs);
        }
      });
    }

    // =====================================================
    // API CALL
    // =====================================================
    async function sendMessage(config, message) {
      try {
        const res = await fetch(`${config.apiBase}/chatbot`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            clientId: config.clientId,
            message,
            channel: 'web'
          })
        });

        return await res.json();
      } catch {
        return {
          response: 'Error al conectar con el bot',
          source: 'default',
          suggestedFaqs: []
        };
      }
    }

    // =====================================================
    // UI HELPERS
    // =====================================================
    function addMessage(role, text) {
      const container = document.getElementById('sam-messages');
      const msg = document.createElement('div');

      msg.style.marginBottom = '10px';
      msg.style.padding = '10px 14px';
      msg.style.borderRadius = DESIGN_TOKENS.borderRadius;
      msg.style.maxWidth = '78%';
      msg.style.fontSize = DESIGN_TOKENS.fontSize;

      if (role === 'user') {
        msg.style.marginLeft = 'auto';
        msg.style.background = DESIGN_TOKENS.userBg;
        msg.style.color = DESIGN_TOKENS.userText;
      } else {
        msg.style.background = DESIGN_TOKENS.botBg;
        msg.style.color = DESIGN_TOKENS.botText;
      }

      msg.innerText = text;
      container.appendChild(msg);
      container.scrollTop = container.scrollHeight;
    }

    function showTyping() {
      const container = document.getElementById('sam-messages');
      typingIndicator = document.createElement('div');
      typingIndicator.innerText = 'âœï¸ SAM estÃ¡ escribiendoâ€¦';
      typingIndicator.style.fontSize = '12px';
      typingIndicator.style.color = '#64748b';
      typingIndicator.style.marginBottom = '8px';
      container.appendChild(typingIndicator);
      container.scrollTop = container.scrollHeight;
    }

    function hideTyping() {
      if (typingIndicator) {
        typingIndicator.remove();
        typingIndicator = null;
      }
    }

    function showFaqSuggestions(config, faqs) {
      const container = document.getElementById('sam-messages');

      const wrapper = document.createElement('div');
      wrapper.style.marginTop = '8px';
      wrapper.style.padding = '10px';
      wrapper.style.background = '#f8fafc';
      wrapper.style.borderRadius = '10px';
      wrapper.style.fontSize = '13px';

      const title = document.createElement('div');
      title.innerText = 'ðŸ’¡ TambiÃ©n puedes preguntarme:';
      title.style.fontWeight = '600';
      title.style.marginBottom = '6px';

      wrapper.appendChild(title);

      faqs.slice(0, 5).forEach((question) => {
        const item = document.createElement('div');
        item.innerText = `â€¢ ${question}`;
        item.style.cursor = 'pointer';
        item.style.color = config.theme?.primaryColor || '#2563eb';

        item.onclick = async () => {
          addMessage('user', question);
          showTyping();
          const res = await sendMessage(config, question);
          hideTyping();
          addMessage('bot', res.response);
        };

        wrapper.appendChild(item);
      });

      container.appendChild(wrapper);
      container.scrollTop = container.scrollHeight;
    }

    function showError(message) {
      document.getElementById('sam-minibot-root').innerHTML =
        `<div class="loading">${message}</div>`;
    }
  </script>
</body>
</html>
